<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDXL Face Swap Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
        }
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #4299e1;
            background-color: rgba(66, 153, 225, 0.1);
        }
        .upload-area.dragover {
            border-color: #3182ce;
            background-color: rgba(49, 130, 206, 0.2);
        }
        .progress-bar {
            background: linear-gradient(90deg, #4299e1, #3182ce);
            border-radius: 10px;
            height: 8px;
            transition: width 0.3s ease;
        }
        .result-card {
            transform: translateY(20px);
            opacity: 0;
            animation: slideUp 0.5s ease forwards;
        }
        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Editor styles */
        .editor-modal {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.7);
        }
        .editor-canvas {
            border: 2px solid #4299e1;
            border-radius: 8px;
            cursor: crosshair;
        }
        .tool-button {
            transition: all 0.2s ease;
        }
        .tool-button.active {
            background: #4299e1;
            color: white;
        }
        .tool-button:hover {
            background: #63b3ed;
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="glass p-6 mb-6">
            <h1 class="text-4xl font-bold text-white text-center mb-2">
                üé≠ SDXL Face Swap Studio
            </h1>
            <p class="text-white text-center opacity-80">
                Generate images with AI and swap faces using InstantID technology
            </p>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Panel - Controls -->
            <div class="glass p-6">
                <h3 class="text-xl font-semibold text-white mb-4">Image to Image</h3>
                
                <!-- File Upload -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-white font-medium mb-2">Base Image</label>
                        <div class="upload-area p-6 text-center cursor-pointer" onclick="document.getElementById('baseImage').click()">
                            <input type="file" id="baseImage" accept="image/*" class="hidden">
                            <div id="baseImagePreview" class="hidden">
                                <img id="baseImageImg" class="max-w-full h-32 object-cover rounded-lg mx-auto">
                            </div>
                            <div id="baseImagePlaceholder">
                                <p class="text-white">üì∑ Click to upload base image</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-white font-medium mb-2">Pose Image</label>
                        <div class="upload-area p-6 text-center cursor-pointer" onclick="document.getElementById('poseImage').click()">
                            <input type="file" id="poseImage" accept="image/*" class="hidden">
                            <div id="poseImagePreview" class="hidden">
                                <img id="poseImageImg" class="max-w-full h-32 object-cover rounded-lg mx-auto">
                            </div>
                            <div id="poseImagePlaceholder">
                                <p class="text-white">üì∑ Click to upload pose image</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-white font-medium mb-2">Top Layer Image</label>
                        <div class="upload-area p-6 text-center cursor-pointer" onclick="document.getElementById('topLayerImage').click()">
                            <input type="file" id="topLayerImage" accept="image/png" class="hidden">
                            <div id="topLayerImagePreview" class="hidden">
                                <img id="topLayerImageImg" class="max-w-full h-32 object-cover rounded-lg mx-auto">
                                <div class="mt-2">
                                    <button id="editTopLayerBtn" 
                                            class="bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded text-sm">
                                        ‚úèÔ∏è Edit Image
                                    </button>
                                </div>
                            </div>
                            <div id="topLayerImagePlaceholder">
                                <p class="text-white">üì∑ Click to upload top layer image (png)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prompt -->
                <div class="mt-4">
                    <label class="block text-white font-medium mb-2">Prompt</label>
                    <textarea id="Prompt" 
                            class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-gray-300 border-opacity-30"
                            rows="2" 
                            placeholder="natural head with hair, detailed hairstyle, photorealistic portrait"></textarea>
                </div>

                <!-- Parameters -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-white font-medium mb-2">IP Adapter Scale</label>
                        <input type="range" id="adapterScale" min="0" max="1" step="0.1" value="0.5" 
                               class="w-full" oninput="document.getElementById('adapterScaleValue').textContent = this.value">
                        <span id="adapterScaleValue" class="text-white text-sm">0.5</span>
                    </div>
                    <div>
                        <label class="block text-white font-medium mb-2">Strength</label>
                        <input type="range" id="Strength" min="0" max="1" step="0.05" value="0.9" 
                               class="w-full" oninput="document.getElementById('StrengthValue').textContent = this.value">
                        <span id="StrengthValue" class="text-white text-sm">0.9</span>
                    </div>
                </div>

                <!-- Additional Parameters -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-white font-medium mb-2">Guidance Scale</label>
                        <input type="range" id="guidanceScale" min="0" max="10" step="0.5" value="3.5" 
                               class="w-full" oninput="document.getElementById('guidanceScaleValue').textContent = this.value">
                        <span id="guidanceScaleValue" class="text-white text-sm">3.5</span>
                    </div>
                    <div>
                        <label class="block text-white font-medium mb-2">Num Step</label>
                        <input type="range" id="numStep" min="0" max="50" step="1" value="30" 
                               class="w-full" oninput="document.getElementById('numStepValue').textContent = this.value">
                        <span id="numStepValue" class="text-white text-sm">30</span>
                    </div>
                </div>
                
                <!-- Seed -->
                <div class="mt-4">
                    <label class="block text-white font-medium mb-2">Seed (0 for random)</label>
                    <input type="number" id="generateSeed" 
                           class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-gray-300 border-opacity-30" 
                           value="0" placeholder="Random seed (0 for random)">
                </div>

                <!-- Generate Button -->
                <button id="generateBtn" 
                        class="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                    üîÑ Generate Image
                </button>

                <!-- Progress Section -->
                <div id="progressSection" class="mt-6 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-white font-medium">Processing...</span>
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="w-full bg-gray-200 bg-opacity-30 rounded-full h-2">
                        <div id="progressBar" class="progress-bar w-0"></div>
                    </div>
                    <div id="progressText" class="text-white text-sm mt-2">Starting...</div>
                </div>
            </div>

            <!-- Right Panel - Results -->
            <div class="glass p-6">
                <h3 class="text-xl font-semibold text-white mb-4">Results</h3>
                
                <div id="resultsContainer" class="space-y-4">
                    <div id="noResults" class="text-center text-white opacity-60 py-12">
                        <div class="text-6xl mb-4">üé®</div>
                        <p>Your generated images will appear here</p>
                    </div>
                </div>

                <!-- Job History -->
                <div class="mt-8">
                    <h4 class="text-lg font-semibold text-white mb-4">Recent Jobs</h4>
                    <div id="jobHistory" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Jobs will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Editor Modal -->
    <div id="editorModal" class="fixed inset-0 editor-modal hidden z-50 flex items-center justify-center p-4">
        <div class="glass max-w-4xl w-full max-h-[90vh] overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-white">Edit Top Layer Image</h3>
                    <button id="closeEditorBtn" class="text-white hover:text-red-400 text-2xl">√ó</button>
                </div>
                
                <!-- Toolbar -->
                <div class="flex flex-wrap gap-2 mb-4 p-3 bg-white bg-opacity-10 rounded-lg">
                    <button id="eraseTool" class="tool-button active px-3 py-2 rounded bg-white bg-opacity-20 text-white text-sm">
                        üßΩ Erase
                    </button>
                    <button id="paintTool" class="tool-button px-3 py-2 rounded bg-white bg-opacity-20 text-white text-sm">
                        üñåÔ∏è Paint
                    </button>
                    <button id="restoreTool" class="tool-button px-3 py-2 rounded bg-white bg-opacity-20 text-white text-sm">
                        üîÑ Restore
                    </button>
                    <div class="flex items-center gap-2 ml-4">
                        <label class="text-white text-sm">Size:</label>
                        <input type="range" id="brushSize" min="1" max="50" value="10" class="w-20">
                        <span id="brushSizeValue" class="text-white text-sm">10</span>
                    </div>
                    <div class="flex items-center gap-2 ml-4">
                        <label class="text-white text-sm">Color:</label>
                        <input type="color" id="paintColor" value="#ffffff" class="w-8 h-8 rounded">
                    </div>
                    <button id="undoBtn" class="tool-button px-3 py-2 rounded bg-white bg-opacity-20 text-white text-sm ml-4">
                        ‚Ü∂ Undo
                    </button>
                    <button id="redoBtn" class="tool-button px-3 py-2 rounded bg-white bg-opacity-20 text-white text-sm">
                        ‚Ü∑ Redo
                    </button>
                    <button id="clearAllBtn" class="tool-button px-3 py-2 rounded bg-red-500 text-white text-sm ml-4">
                        üóëÔ∏è Clear All
                    </button>
                    <button id="restoreAllBtn" class="tool-button px-3 py-2 rounded bg-blue-500 text-white text-sm" onclick="restoreAll()">
                        üîÑ Restore All
                    </button>
                </div>
                
                <!-- Canvas Container -->
                <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                    <canvas id="editorCanvas" class="editor-canvas max-w-full h-auto"></canvas>
                </div>
                
                <!-- Save/Cancel Buttons -->
                <div class="flex gap-4 mt-4">
                    <button id="saveEditsBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg">
                        ‚úÖ Save Changes
                    </button>
                    <button id="cancelEditsBtn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg">
                        ‚ùå Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentJobs = new Set();
        let isEditing = false;
        let currentTool = 'erase';
        let isDrawing = false;
        let undoStack = [];
        let redoStack = [];
        
        // Editor variables
        let editorCanvas, editorCtx;
        let originalImageData;
        
        // Initialize editor
        function initEditor() {
            editorCanvas = document.getElementById('editorCanvas');
            editorCtx = editorCanvas.getContext('2d');
            
            // Tool selection
            document.getElementById('eraseTool').addEventListener('click', () => setTool('erase'));
            document.getElementById('paintTool').addEventListener('click', () => setTool('paint'));
            document.getElementById('restoreTool').addEventListener('click', () => setTool('restore'));
            
            // Brush size
            document.getElementById('brushSize').addEventListener('input', (e) => {
                document.getElementById('brushSizeValue').textContent = e.target.value;
            });
            
            // Canvas events
            editorCanvas.addEventListener('mousedown', startDrawing);
            editorCanvas.addEventListener('mousemove', draw);
            editorCanvas.addEventListener('mouseup', stopDrawing);
            editorCanvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            editorCanvas.addEventListener('touchstart', handleTouch);
            editorCanvas.addEventListener('touchmove', handleTouch);
            editorCanvas.addEventListener('touchend', stopDrawing);
            
            // Buttons
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);
            document.getElementById('clearAllBtn').addEventListener('click', clearAll);
            document.getElementById('saveEditsBtn').addEventListener('click', saveEdits);
            document.getElementById('cancelEditsBtn').addEventListener('click', cancelEdits);
            document.getElementById('closeEditorBtn').addEventListener('click', closeEditor);
        }
        
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + 'Tool').classList.add('active');
            
            // Update cursor based on tool
            if (tool === 'erase') {
                editorCanvas.style.cursor = 'crosshair';
            } else if (tool === 'paint') {
                editorCanvas.style.cursor = 'crosshair';
            } else if (tool === 'restore') {
                editorCanvas.style.cursor = 'copy';
            }
        }
        
        function openEditor() {
            const topLayerImg = document.getElementById('topLayerImageImg');
            if (!topLayerImg.src) return;
            
            isEditing = true;
            document.getElementById('editorModal').classList.remove('hidden');
            
            // Load image to canvas
            const img = new Image();
            img.onload = function() {
                // Set canvas size to match image
                editorCanvas.width = img.width;
                editorCanvas.height = img.height;
                
                // Draw image on canvas
                editorCtx.drawImage(img, 0, 0);
                
                // Save original state for restore functionality
                originalImageData = editorCtx.getImageData(0, 0, editorCanvas.width, editorCanvas.height);
                saveState();
            };
            img.src = topLayerImg.src;
        }
        
        function closeEditor() {
            document.getElementById('editorModal').classList.add('hidden');
            isEditing = false;
            undoStack = [];
            redoStack = [];
        }
        
        function saveState() {
            undoStack.push(editorCtx.getImageData(0, 0, editorCanvas.width, editorCanvas.height));
            if (undoStack.length > 50) undoStack.shift(); // Limit undo stack
            redoStack = []; // Clear redo stack when new action is performed
        }
        
        function undo() {
            if (undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                const prevState = undoStack[undoStack.length - 1];
                editorCtx.putImageData(prevState, 0, 0);
            }
        }
        
        function redo() {
            if (redoStack.length > 0) {
                const nextState = redoStack.pop();
                undoStack.push(nextState);
                editorCtx.putImageData(nextState, 0, 0);
            }
        }
        
        function clearAll() {
            if (confirm('Are you sure you want to clear the entire image?')) {
                editorCtx.clearRect(0, 0, editorCanvas.width, editorCanvas.height);
                saveState();
            }
        }
        
        function restoreAll() {
            if (confirm('Are you sure you want to restore the entire image to original?')) {
                editorCtx.putImageData(originalImageData, 0, 0);
                saveState();
            }
        }
        
        function getMousePos(e) {
            const rect = editorCanvas.getBoundingClientRect();
            const scaleX = editorCanvas.width / rect.width;
            const scaleY = editorCanvas.height / rect.height;
            
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }
        
        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            editorCanvas.dispatchEvent(mouseEvent);
        }
        
        function startDrawing(e) {
            isDrawing = true;
            const pos = getMousePos(e);
            
            const brushSize = parseInt(document.getElementById('brushSize').value);
            
            if (currentTool === 'erase') {
                editorCtx.globalCompositeOperation = 'destination-out';
                editorCtx.lineWidth = brushSize;
                editorCtx.lineCap = 'round';
                editorCtx.lineJoin = 'round';
                editorCtx.beginPath();
                editorCtx.moveTo(pos.x, pos.y);
            } else if (currentTool === 'paint') {
                editorCtx.globalCompositeOperation = 'source-over';
                editorCtx.strokeStyle = document.getElementById('paintColor').value;
                editorCtx.lineWidth = brushSize;
                editorCtx.lineCap = 'round';
                editorCtx.lineJoin = 'round';
                editorCtx.beginPath();
                editorCtx.moveTo(pos.x, pos.y);
            } else if (currentTool === 'restore') {
                // For restore, we'll use a circular brush to restore original content
                restoreAtPosition(pos.x, pos.y, brushSize);
            }
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const pos = getMousePos(e);
            
            if (currentTool === 'erase' || currentTool === 'paint') {
                editorCtx.lineTo(pos.x, pos.y);
                editorCtx.stroke();
            } else if (currentTool === 'restore') {
                const brushSize = parseInt(document.getElementById('brushSize').value);
                restoreAtPosition(pos.x, pos.y, brushSize);
            }
        }
        
        function restoreAtPosition(x, y, radius) {
            // Save current composite operation
            const currentOperation = editorCtx.globalCompositeOperation;
            
            // Create a circular clipping path
            editorCtx.save();
            editorCtx.beginPath();
            editorCtx.arc(x, y, radius / 2, 0, 2 * Math.PI);
            editorCtx.clip();
            
            // Calculate the area to restore from original image
            const startX = Math.max(0, Math.floor(x - radius / 2));
            const startY = Math.max(0, Math.floor(y - radius / 2));
            const endX = Math.min(editorCanvas.width, Math.ceil(x + radius / 2));
            const endY = Math.min(editorCanvas.height, Math.ceil(y + radius / 2));
            
            const width = endX - startX;
            const height = endY - startY;
            
            if (width > 0 && height > 0) {
                // Get the original image data for this area
                const originalData = editorCtx.createImageData(width, height);
                const sourceData = originalImageData.data;
                const canvasWidth = originalImageData.width;
                
                // Copy pixels from original image
                for (let py = 0; py < height; py++) {
                    for (let px = 0; px < width; px++) {
                        const sourceIndex = ((startY + py) * canvasWidth + (startX + px)) * 4;
                        const targetIndex = (py * width + px) * 4;
                        
                        originalData.data[targetIndex] = sourceData[sourceIndex];         // R
                        originalData.data[targetIndex + 1] = sourceData[sourceIndex + 1]; // G
                        originalData.data[targetIndex + 2] = sourceData[sourceIndex + 2]; // B
                        originalData.data[targetIndex + 3] = sourceData[sourceIndex + 3]; // A
                    }
                }
                
                // Put the original image data back
                editorCtx.putImageData(originalData, startX, startY);
            }
            
            editorCtx.restore();
        }
        
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveState();
            }
        }
        
        function saveEdits() {
            // Convert canvas to blob and update the image
            editorCanvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                document.getElementById('topLayerImageImg').src = url;
                
                // Create a new File object to replace the original
                const file = new File([blob], 'edited_toplayer.png', { type: 'image/png' });
                
                // Update the file input (we'll store the file reference)
                const fileInput = document.getElementById('topLayerImage');
                // Create a new FileList-like object
                const dt = new DataTransfer();
                dt.items.add(file);
                fileInput.files = dt.files;
                
                closeEditor();
            }, 'image/png');
        }
        
        function cancelEdits() {
            closeEditor();
        }
        
        // Setup file input for base image
        const baseInput = document.getElementById('baseImage');
        const basePreview = document.getElementById('baseImagePreview');
        const basePlaceholder = document.getElementById('baseImagePlaceholder');
        const baseImg = document.getElementById('baseImageImg');
        const poseInput = document.getElementById('poseImage');
        const posePreview = document.getElementById('poseImagePreview');
        const posePlaceholder = document.getElementById('poseImagePlaceholder');
        const poseImg = document.getElementById('poseImageImg');
        const topLayerInput = document.getElementById('topLayerImage');
        const topLayerPreview = document.getElementById('topLayerImagePreview');
        const topLayerPlaceholder = document.getElementById('topLayerImagePlaceholder');
        const topLayerImg = document.getElementById('topLayerImageImg');
        
        baseInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    baseImg.src = e.target.result;
                    basePreview.classList.remove('hidden');
                    basePlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
        
        poseInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    poseImg.src = e.target.result;
                    posePreview.classList.remove('hidden');
                    posePlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
        
        topLayerInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    topLayerImg.src = e.target.result;
                    topLayerPreview.classList.remove('hidden');
                    topLayerPlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Edit button event listener
        document.getElementById('editTopLayerBtn').addEventListener('click', openEditor);
        
        // Generate button event listener
        document.getElementById('generateBtn').addEventListener('click', async () => {
            const baseImageFile = document.getElementById('baseImage').files[0];
            const poseImageFile = document.getElementById('poseImage').files[0];
            const topLayerImageFile = document.getElementById('topLayerImage').files[0];
            const prompt = document.getElementById('Prompt').value;
            
            if (!baseImageFile) {
                alert('Please upload a base image');
                return;
            }

            if (!poseImageFile) {
                alert('Please upload a pose image');
                return;
            }
            if (!topLayerImageFile) {
                alert('Please upload a top layer image');
                return;
            }
           
            if (!prompt.trim()) {
                alert('Please enter a prompt');
                return;
            }
            
            const formData = new FormData();
            formData.append('base_image', baseImageFile);
            formData.append('pose_image', poseImageFile);
            formData.append('top_layer_image', topLayerImageFile);
            formData.append('prompt', prompt);
            formData.append('ip_adapter_scale', document.getElementById('adapterScale').value);
            formData.append('strength', document.getElementById('Strength').value);
            formData.append('num_inference_steps', document.getElementById('numStep').value);
            formData.append('guidance_scale', document.getElementById('guidanceScale').value);
            formData.append('seed', document.getElementById('generateSeed').value);

            try {
                const response = await fetch(`/img2img`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (response.ok) {
                    startJobPolling(result.job_id);
                } else {
                    throw new Error(result.detail || 'Generation failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
        
        // Job polling function
        function startJobPolling(jobId) {
            currentJobs.add(jobId);
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('noResults').classList.add('hidden');
            
            const poll = async () => {
                try {
                    const response = await fetch(`/job/${jobId}`);
                    const job = await response.json();
                    
                    updateProgressBar(job.progress * 100);
                    document.getElementById('progressText').textContent = job.status;
                    
                    if (job.status === 'completed') {
                        currentJobs.delete(jobId);
                        document.getElementById('progressSection').classList.add('hidden');
                        addResult(job.result_url, jobId, job.seed || 'N/A');
                        updateJobHistory();
                    } else if (job.status === 'failed') {
                        currentJobs.delete(jobId);
                        document.getElementById('progressSection').classList.add('hidden');
                        alert('Job failed: ' + (job.error_message || 'Unknown error'));
                        updateJobHistory();
                    } else {
                        setTimeout(poll, 1000);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    setTimeout(poll, 2000);
                }
            };
            
            poll();
        }
        
        function updateProgressBar(progress) {
            document.getElementById('progressBar').style.width = progress + '%';
        }
        
        function addResult(imageUrl, jobId, seedValue) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card bg-white bg-opacity-10 rounded-lg p-4';
            resultCard.innerHTML = `
                <img src="${imageUrl}" alt="Generated Image" class="w-full rounded-lg mb-3">
                <div class="text-white text-sm mb-2">Seed: ${seedValue}</div>
                <div class="flex space-x-2">
                    <button onclick="downloadImage('${imageUrl}', 'result_${jobId}.png')" 
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm">
                        üì• Download
                    </button>
                    <button onclick="useAsBase('${imageUrl}')" 
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg text-sm">
                        üîÑ Use as Base
                    </button>
                </div>
            `;
            
            resultsContainer.appendChild(resultCard);
        }
        
        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function updateJobHistory() {
            try {
                const response = await fetch(`/jobs`);
                const data = await response.json();
                
                const jobHistory = document.getElementById('jobHistory');
                jobHistory.innerHTML = '';
                
                let jobs = [];
                if (Array.isArray(data)) {
                    jobs = data;
                } else if (data.jobs && Array.isArray(data.jobs)) {
                    jobs = data.jobs;
                } else if (typeof data === 'object') {
                    jobs = Object.values(data);
                }
                
                if (jobs.length === 0) {
                    jobHistory.innerHTML = '<div class="text-white text-center opacity-60">No jobs yet</div>';
                    return;
                }
                
                jobs.forEach(job => {
                    const jobElement = document.createElement('div');
                    jobElement.className = 'bg-white bg-opacity-10 rounded-lg p-3';
                    
                    const jobId = job.job_id || job.id || 'Unknown';
                    const status = job.status || 'Unknown';
                    const createdAt = job.created_at || job.timestamp || new Date().toISOString();
                    
                    jobElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-white font-medium">${jobId.toString().substr(0, 8)}...</div>
                                <div class="text-white text-sm opacity-60">${status}</div>
                            </div>
                            <div class="text-white text-sm">
                                ${new Date(createdAt).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                    jobHistory.appendChild(jobElement);
                });
            } catch (error) {
                console.error('Failed to update job history:', error);
                const jobHistory = document.getElementById('jobHistory');
                jobHistory.innerHTML = '<div class="text-white text-center opacity-60">Failed to load job history</div>';
            }
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            initEditor();
            updateJobHistory();
            
            // Check API health on load
            fetch(`/health`)
                .then(response => response.json())
                .then(data => {
                    if (!data.pipelines_loaded) {
                        alert('Warning: AI models are still loading. Please wait a moment before generating images.');
                    }
                })
                .catch(error => {
                    alert('Cannot connect to API server. Please make sure the backend is running on http://localhost:8888');
                });
        });
    </script>
</body>
</html>